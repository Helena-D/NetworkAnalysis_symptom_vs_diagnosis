---
title: 'Sensitivity analysis: Network analysis ANB only'
author: "Helena Davies"
date: "11/02/2022"
output: html_document
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Read in file with path to data channel
```{r Read in file with path to data channel on teams}
source(file = "../../credentials/paths.R")
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = paste0(filepath_functions, "add_numeric.R"))
source(file = paste0(filepath_functions, "remove_duplicates.R"))
source(file = paste0(filepath_functions, "package_check.R"))
source("./functions.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c("summarytools",
              "sjlabelled",
              "Amelia",
              "gtsummary",
              "janitor",
              "psych",
              "corrplot",
              "rstatix",
              "networktools",
              "nnet",
              "bootnet",
              "caret",
              "Matrix",
              "qgraph",
              "NetworkComparisonTest",
              "tidyverse")
package_check(packages)
```

Retrieve recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date <- Sys.Date()
date
```
        
# Read in merged data with variables created
Read in data 
```{r Read in data}
# Diagnosis dat
diagnosis_dat <- readRDS(file = "../../data/diagnosis_dat_analysis2023-04-11.rds")
dim(diagnosis_dat)
colnames(diagnosis_dat)

# Select and rename variables
diagnosis_dat <- diagnosis_dat %>%
  select(
    ID,
    sample,
    age = age_dx_level,
    sex = sex_final,
    sex_numeric = sex_final_numeric,
    ethnicity,
    bmi_signup = bmi_signup_dx_level,
    bmi_lowest =bmi_lowest_dx_level,
    bmi_highest = bmi_highest_dx_level,
    ED_hierarchical_sens_ANB_numeric,
    ED_hierarchical_sens_ANB,
    more_hyperactivity = more_hyperactivity_dx_level,
   more_irritability= more_irritability_dx_level,
   more_self_confidence = more_self_confidence_dx_level,
   less_sleep = less_sleep_dx_level,                    
   more_talkative = more_talkative_dx_level,
   racing_thoughts = racing_thoughts_dx_level,
   conc_difficulties = conc_difficulties_dx_level,     
   more_energy = more_energy_dx_level,
   more_active = more_active_dx_level,
   more_social = more_social_dx_level,             
   higher_libido = higher_libido_dx_level,
   more_risky_beh = more_risky_beh_dx_level,
   reckless_spending = reckless_spending_dx_level,
   
   more_hyperactivity_numeric = more_hyperactivity_numeric_dx_level,
   more_irritability_numeric= more_irritability_numeric_dx_level,
   more_self_confidence_numeric = more_self_confidence_numeric_dx_level,
   less_sleep_numeric = less_sleep_numeric_dx_level,                    
   more_talkative_numeric = more_talkative_numeric_dx_level,
   racing_thoughts_numeric = racing_thoughts_numeric_dx_level,
   conc_difficulties_numeric = conc_difficulties_numeric_dx_level,     
   more_energy_numeric = more_energy_numeric_dx_level,
   more_active_numeric = more_active_numeric_dx_level,
   more_social_numeric = more_social_numeric_dx_level,             
   higher_libido_numeric = higher_libido_numeric_dx_level,
   more_risky_beh_numeric = more_risky_beh_numeric_dx_level,
   reckless_spending_numeric = reckless_spending_numeric_dx_level
    ) 
```

# NETWORKS 
## Preprocessing check assessing collinearity 
### Diagnosis data
Main nodes:
1...you felt so good or so hyper that other people thought you were not your normal self or you were so hyper that you got into trouble? (hyp)
2...you got much less sleep than usual and found you didn't really miss it? (sle)
3...you were so easily distracted by things around you that you had trouble concentrating or staying on track? (con)
4...you were much more social or outgoing than usual, for example, you telephoned friends in the middle of the night? (soc)
5..spending money got you or your family into trouble? (mon)
6...you were so irritable that you shouted at people or start fights or arguments? (irr)
7...you were much more talkative or spoke much faster than usual? (tal)
8...you had much more energy than usual? (ene)
9...you were much more interested in sex than usual? (sex)
10...you felt much more self-confident than usual? (scf)
11...thoughts raced through your head or you couldn't slow your mind down? (rac)
12..you were much more active or did many more things than usual? (act)
13...you did things that were unusual for you or that other people might have thought were excessive, foolish, or risky? (ris)

(From Lissy's paper: "Pre-processing checks assessing collinearity were conducted using the ‘goldbricker’ function from the R package ‘networktools’, which compares correlations in order to identify nodes which are likely to measure the same underlying construct").
```{r goldbrick function assessing collinearity diagnosis data diagnosis data}
mania_nodes_ANB <- diagnosis_dat %>%
   filter(ED_hierarchical_sens_ANB == "Anorexia with binge eating") %>%
  select(
   more_hyperactivity_numeric,
   more_irritability_numeric,
   more_self_confidence_numeric,
   less_sleep_numeric,                    
   more_talkative_numeric,
   racing_thoughts_numeric,
   conc_difficulties_numeric,     
   more_energy_numeric,
   more_active_numeric,
   more_social_numeric,             
   higher_libido_numeric,
   more_risky_beh_numeric,
   reckless_spending_numeric,
   sex_numeric,
   age
  )

mania_nodes_BN <- diagnosis_dat %>%
   filter(ED_hierarchical_sens_ANB == "Bulimia nervosa") %>%
  select(
   more_hyperactivity_numeric,
   more_irritability_numeric,
   more_self_confidence_numeric,
   less_sleep_numeric,                    
   more_talkative_numeric,
   racing_thoughts_numeric,
   conc_difficulties_numeric,     
   more_energy_numeric,
   more_active_numeric,
   more_social_numeric,             
   higher_libido_numeric,
   more_risky_beh_numeric,
   reckless_spending_numeric,
   sex_numeric,
   age
  )


mania_nodes_BED <- diagnosis_dat %>%
   filter(ED_hierarchical_sens_ANB == "Binge-eating disorder") %>%
  select(
   more_hyperactivity_numeric,
   more_irritability_numeric,
   more_self_confidence_numeric,
   less_sleep_numeric,                    
   more_talkative_numeric,
   racing_thoughts_numeric,
   conc_difficulties_numeric,     
   more_energy_numeric,
   more_active_numeric,
   more_social_numeric,             
   higher_libido_numeric,
   more_risky_beh_numeric,
   reckless_spending_numeric,
   sex_numeric,
   age
  )

# Use goldbricker function on each network
goldbricker_diagnosis_ANB <- networktools::goldbricker(mania_nodes_ANB,
            p = 0.05,
            method = "hittner2003",
            threshold = 0.25,
            corMin = 0.5,
            progressbar = TRUE

                        )
# This will return a vector of 'bad pairs' and their suggested reductions
goldbricker_diagnosis_ANB$suggested_reductions

goldbricker_diagnosis_BN <- networktools::goldbricker(mania_nodes_BN,
            p = 0.05,
            method = "hittner2003",
            threshold = 0.25,
            corMin = 0.5,
            progressbar = TRUE
            )

# This will return a vector of 'bad pairs' and their suggested reductions
goldbricker_diagnosis_BN$suggested_reductions

goldbricker_diagnosis_BED <- networktools::goldbricker(mania_nodes_BED,
            p = 0.05,
            method = "hittner2003",
            threshold = 0.25,
            corMin = 0.5,
            progressbar = TRUE
            )

# This will return a vector of 'bad pairs' and their suggested reductions
goldbricker_diagnosis_BED$suggested_reductions
```

## Preprocessing check assessing variance
The function nearZeroVar from the caret packageremoves predictors that have one unique value across samples (zero variance predictors), and also removes predictors that have both 1) few unique values relative to the number of samples and 2) large ratio of the frequency of the most common value to the frequency of the second most common value (near-zero variance predictors).

By default, a predictor is classified as near-zero variance if the percentage of unique values in the samples is less than {10\%} and when the frequency ratio mentioned above is greater than 19 (95/5). These default values can be changed by setting the arguments uniqueCut and freqCut.

freqRatio = the ratio of frequencies for the most common value over the second most common value

percentUnique = the percentage of unique data points out of the total number of data points

zeroVar = a vector of logicals for whether the predictor has only one distinct value

nzv = a vector of logicals for whether the predictor is a near zero variance predictor
```{r preprocessing variance diagnosis data}
variance_ANB <- nearZeroVar(mania_nodes_ANB,
            names = TRUE,
            saveMetrics = TRUE)

variance_ANB # The sex variable is a nero-zero-variance predictor in the ANB network, but not in the BN or BED networks. However, you can't compare models with different nodes, so we have decided to keep it in the ANB network. 

variance_BN <- nearZeroVar(mania_nodes_BN,
            names = TRUE,
            saveMetrics = TRUE)

variance_BN

variance_BED <- nearZeroVar(mania_nodes_BED,
            names = TRUE,
            saveMetrics = TRUE)

variance_BED
```

### Abbreviations of symptoms 
```{r abbreviations of symptoms }
shortnames <- c(
  "hyp",
                "irr",
                "scf",
                "sle",
                "talk",
                "rac",
                "con",
                "ene",
                "act",
                "soc",
                "lib",
                "ris",
                "mon",
                "sex",
                "age")
```

### Long names 
```{r nodes long names }
longnames <- c(
  "Hyperactivity",
  "More irritability",
  "More self-confidence",
  "Less sleep",
  "More talkative",
  "Racing thoughts",
  "Concentration difficulties",
  "More energy",
  "More active",
  "More social",
  "Higher libido",
  "Unusual and/or risky behaviour",
  "Reckless spending",
  "Sex",
  "Age"
  )
```

### Generate initial network for use in generating predictability estimates ANB
```{r initial network for use in predictability ANB}
# Type of variable. C = categorical, g = gaussian
type = c(rep("c", 14),
         "g")

# Number of levels. For the first 14 variables, there are 2 levels (0 and 1). The last variable (age) is continuous so level is set to 1.
level = c(rep(2, 14), 
          1) 

ANB_network <- mgm::mgm(mania_nodes_ANB,
                  type = type,
                  level = level,
                  lambdaSel = "EBIC",
                  lambdaGam = 0.25,
                  binarySign = TRUE, 
                  scale = TRUE)
```

### Adding predictability of nodes ANB
From this paper: https://link.springer.com/article/10.3758/s13428-017-0910-x
```{r generating predictability of nodes ANB}
p_obj <- predict(object = ANB_network,
                 data = mania_nodes_ANB,
                 errorCat = c("CC", "nCC", "CCmarg"),
                 errorCon = c("R2"))

p_obj$error

# To display both the accuracy of the intercept model and the normalized accuracy (contribution by other variables), we require a list for the ring-segments and a list for the corresponding colors:

error_list_ANB <- list() # List for ring segments
beyondmarg <- vector()

for(i in 1:14) beyondmarg[[i]] <- p_obj$errors[i, 3]-p_obj$errors[i, 5]
for(i in 1:14) error_list_ANB[[i]] <- c(p_obj$errors[i, 5], beyondmarg[[i]])
error_list_ANB[[15]] <- p_obj$errors[15,2]

color_list <- list() # List for colours
for(i in 1:14) color_list[[i]] <- c("#ffa500", "#ff4300")
#color_list[[15]] <- p_obj$errors[15,2]
color_list[[15]] <- "#90B4D4"
```

### Walktrap algorithm: 
https://www.nature.com/articles/srep05918
https://pure.uva.nl/ws/files/21235882/Network_Analysis_on_Attitudes.png
Walktrap, developed by Pascal Pons, is an algorithm in graph theory, used to identify communities in large networks via random walks. These random walks are then used to compute distances between nodes. Nodes are then assigned into groups with small intra and larger inter-community distances via bottom-up hierarchical clustering. It should be noted, of course, that this algorithm considers only one community per node, which in some cases can be an incorrect hypothesis.
```{r walktrap algorithm ANB}
# Create an igraph object containing the information on the  network and take the absolute values of the edge weights because the walktrap algorithm can only deal with positive edge values

ANB_network <- estimateNetwork(mania_nodes_ANB,
                               default = "mgm",
                               type = type,
                               level = level,
                               tuning = 0.25,
                               binarySign = TRUE)


ANBigraph <- igraph::graph_from_adjacency_matrix(abs(ANB_network$graph), 
                                      weighted =TRUE,
                                      add.colnames = FALSE)


# Run walktrap algorithm on the network 
ANBCom <- igraph::cluster_walktrap(ANBigraph)

# Extract the found communities using the following command:
ANBcommunities <- igraph::communities(ANBCom)

# Manually move age and sex into their own community (they are covariates. We estimated the groups first because we need the associations that have been adjusted for age and sex, but do not want them to form part of a group because they are not symptoms) 
ANBcommunities$`3` <- c(14,
                        15)

ANBcommunities$`1`  <- c(1,
                         2,
                         4,
                         5,
                         6,
                         7,
                         8,
                         9)

# Rename clusters
ANBcommunities$`Cluster 1` <- ANBcommunities$`1` 
ANBcommunities$`1`  <- NULL

ANBcommunities$`Cluster 2` <- ANBcommunities$`2` 
ANBcommunities$`2`  <- NULL

ANBcommunities$`Covariates` <- ANBcommunities$`3` 
ANBcommunities$`3`  <- NULL
```

### Plot ANB network with walktrap algorithm AND predictability of nodes 
Using mgm package
```{r plotting ANB network with walktrap and predictability}
# Type of variable. C = categorical, g = gaussian
type = c(rep("c", 14),
         "g")

# Number of levels. For the first 14 variables, there are 2 levels (0 and 1). The last variable (age) is continuous so level is set to 1.
level = c(rep(2, 14), 
          1) 

ANB_network <- mgm::mgm(mania_nodes_ANB,
                  type = type,
                  level = level,
                  lambdaSel = "EBIC",
                  lambdaGam = 0.25,
                  binarySign = TRUE, 
                  scale = TRUE)

ANB_network_plot <- qgraph::qgraph(ANB_network$pairwise$wadj, # weighted adjacency matrix as input
       #layout = layout, 
       pie = error_list_ANB, # provide errors as input
       pieColor = color_list,
       edge.color = "blue3",
       cut = 0, 
       labels = shortnames,
       nodeNames = longnames,
       groups =  ANBcommunities,
       palette = "colorblind",
       label.scale = T,
       title = "Network of mania symptoms in ANB sample,
                   n = 400"
      )
```

### Plot using the bootnet package for use in later analyses (e.g., centrality estimates, etc)
```{r plotting network using estimateNetwork ANB}
ANB_network_bootnet <- estimateNetwork(mania_nodes_ANB,
                               default = "mgm",
                               type = type,
                               level = level,
                               tuning = 0.25,
                               binarySign = TRUE,
                               criterion = "EBIC",
                        labels = shortnames)



ANB_network_bootnet_plot <- plot(ANB_network_bootnet,
                           layout = "spring",
                           labels = shortnames, 
                           nodeNames = longnames,
                           legend = TRUE,
                           title = paste("Symptom network of mania items in ANB sample,
                   n =", ANB_network_bootnet$nPerson))
```

### ANB network information
```{r ANB network information ANB}
ANB_network_bootnet$graph # the weights (adjacency) matrix of the network (symmetrical in undirected networks)
ANB_network_bootnet$intercepts # the thresholds (represent the intercept for each symptom in the regularized logistic regression analyses used to estimate the networks)
ANB_network_bootnet$results # weights matrix and intercepts
ANB_network_bootnet$labels # variable labels
ANB_network_bootnet$nNodes # number of nodes in network
ANB_network_bootnet$nPerson # number of persons in network
```

### ANB centrality estimates
```{r centrality estimates ANB}
# Raw centrality measures (not standardised)
qgraph::centrality(ANB_network_bootnet)

# Standardised centrality estimates [node strength]
plot(qgraph::centrality(ANB_network_bootnet)$InDegree,
     type = "b") 

# Standardised centrality estimated for four centrality indices
qgraph::centralityTable(ANB_network_bootnet,
               labels = longnames)

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/centrality_plot_ANB_",date,".png")) 

qgraph::centralityPlot(ANB_network_bootnet, # NB: For these plots, age and sex have to be included. Can't remove them.
               include ="all",
               labels = longnames) 

dev.off()

```

### ANB Edge weight accuracy
Use the bootnet() function to estimate edge weight accuracy and centrality stability and plot them
See: Estimating psychological networks and their accuracy: A tutorial paper
Bootstrapping = picking people with replacement, i.e. each sample will have a different composition of people (e.g. choosing a random 70% of the sample each time)
```{r edge weight accuracy ANB network}
edge_accuracy_ANB_network <- bootnet(ANB_network_bootnet,
                                     nBoots = 1000, # 1000 bootstraps of networks using a different sub sample each time; compare all of these networks that we just estimated
                                     nCores = 4,
                                     statistics = c("edge", 
                                                    "strength",
                                                    "betweenness",
                                                    "closeness",
                                                    "expectedInfluence"),
                                     labels = shortnames
                                     ) 

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/edge_accuracy_plot_ANB_",date,".png")) 

plot(edge_accuracy_ANB_network, 
                                      #plot = "interval",
                                      # split0 = TRUE,
                                      order = "sample",
                                       labels = FALSE)

dev.off()

edge_accuracy_ANB_network_plot <- plot(edge_accuracy_ANB_network, 
                                      #plot = "interval",
                                      # split0 = TRUE,
                                      order = "sample",
                                       labels = TRUE)

edge_accuracy_ANB_network_plot

# This function makes a ’multiverse’ plot of bootstrap results. Every row indicates an edge and every column a bootstrap; colors are in line of the edge strength as drawn with plot.bootnetResult.
#multiverse(edge_accuracy_ANB_network_plot,
#           labels = T) 
```

### ANB centrality accuracy
```{r centrality accuracy ANB network}
centrality_stability_ANB_network <- bootnet(ANB_network_bootnet,
                                nBoots = 1000, 
                                nCores = 1,
                                type = "case", #case-dropping bootstrap
                                statistics = c("closeness",
                                               "strength",
                                               "betweenness",
                                               "expectedInfluence")) 

centrality_stability_ANB_network

# Table of all statistics from original sample 
centrality_stability_ANB_network$sampleTable 

# Results of bootstrap
centrality_stability_ANB_network$boots

# Table of all statistics from bootstraps
centrality_stability_ANB_network$bootTable

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/centrality_stability_plot_ANB_",date,".png")) 

# Plot centrality stability
plot(centrality_stability_ANB_network,
     statistics = c("expectedInfluence"))

dev.off()

centrality_stability_ANB_network_plot <- plot(centrality_stability_ANB_network,
                                              statistics = c("closeness",
                                                             "strength",
                                                             "betweenness",
                                                             "expectedInfluence"))

centrality_stability_ANB_network_plot


# CS-coefficient (to quantify the centrality stability)
corStability(centrality_stability_ANB_network,
              cor = 0.7,
              statistics = "all")
```

### Test significance of differences (between edge weights and node centralities) to test for differences within a single network 
Significance: Specific edge weights 
```{r test significance of differences of specific edge weight ANB network}
# Plot significant differences (alpha = 0.05) of edge weights:
png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/sig_diff_edges_plot_ANB_",date,".png")) 

plot(edge_accuracy_ANB_network,
     "edge",
     plot = "difference",
     onlyNonZero = TRUE,
     order = "sample",
     labels = TRUE
     )

dev.off()
```

Significance: Node centralities
```{r test significance of differences of node centralities ANB network}
# Plot significant differences (alpha = 0.05) of node centrality eg. strength for all nodes:
png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/sig_diff_node_centralities_plot_ANB_",date,".png")) 

plot(edge_accuracy_ANB_network,
     "expectedInfluence",
     plot = "difference",
     order = "sample"
     ) # Note: use edge accuracy estimates for this as centrality is a measure of connecting edges

dev.off()
# Test for difference in strength between specific nodes - perhaps more useful if you have apriori reason to explore specific differents in nodes
# Eg. difference in centrality between ene and expectedInfluence for strength 
# differenceTest(edge_accuracy_ED_network,  "ene", "rac", "expectedInfluence")
```

# BN
### Generate initial network for use in generating predictability estimates BN
```{r initial network for use in predictability BN}
# Type of variable. C = categorical, g = gaussian
type = c(rep("c", 14),
         "g")

# Number of levels. For the first 14 variables, there are 2 levels (0 and 1). The last variable (age) is continuous so level is set to 1.
level = c(rep(2, 14), 
          1) 

BN_network <- mgm::mgm(mania_nodes_BN,
                  type = type,
                  level = level,
                  lambdaSel = "EBIC",
                  lambdaGam = 0.25,
                  binarySign = TRUE, 
                  scale = TRUE)
```

### Adding predictability of nodes BN
From this paper: https://link.springer.com/article/10.3758/s13428-017-0910-x
```{r generating predictability of nodes BN}
p_obj <- predict(object = BN_network,
                 data = mania_nodes_BN,
                 errorCat = c("CC", "nCC", "CCmarg"),
                 errorCon = c("R2"))

p_obj$error

# To display both the accuracy of the intercept model and the normalized accuracy (contribution by other variables), we require a list for the ring-segments and a list for the corresponding colors:

error_list_BN <- list() # List for ring segments
beyondmarg <- vector()

for(i in 1:14) beyondmarg[[i]] <- p_obj$errors[i, 3]-p_obj$errors[i, 5]
for(i in 1:14) error_list_BN[[i]] <- c(p_obj$errors[i, 5], beyondmarg[[i]])
error_list_BN[[15]] <- p_obj$errors[15,2]

color_list <- list() # List for colours
for(i in 1:14) color_list[[i]] <- c("#ffa500", "#ff4300")
#color_list[[15]] <- p_obj$errors[15,2]
color_list[[15]] <- "#90B4D4"
```

### Walktrap algorithm: 
https://www.nature.com/articles/srep05918
https://pure.uva.nl/ws/files/21235882/Network_Analysis_on_Attitudes.png
Walktrap, developed by Pascal Pons, is an algorithm in graph theory, used to identify communities in large networks via random walks. These random walks are then used to compute distances between nodes. Nodes are then assigned into groups with small intra and larger inter-community distances via bottom-up hierarchical clustering. It should be noted, of course, that this algorithm considers only one community per node, which in some cases can be an incorrect hypothesis.
```{r walktrap algorithm BN}
# Create an igraph object containing the information on the  network and take the absolute values of the edge weights because the walktrap algorithm can only deal with positive edge values

BN_network <- estimateNetwork(mania_nodes_BN,
                               default = "mgm",
                               type = type,
                               level = level,
                               tuning = 0.25,
                               binarySign = TRUE)


BNigraph <- igraph::graph_from_adjacency_matrix(abs(BN_network$graph), 
                                      weighted =TRUE,
                                      add.colnames = FALSE)


# Run walktrap algorithm on the network 
BNCom <- igraph::cluster_walktrap(BNigraph)

# Extract the found communities using the following command:
BNcommunities <- igraph::communities(BNCom)

# Manually move age and sex into their own community (they are covariates. We estimated the groups first because we need the associations that have been adjusted for age and sex, but do not want them to form part of a group because they are not symptoms)
BNcommunities$`1` <- c(2,
                       6,
                       7,
                       12,
                       13)


BNcommunities$`3`  <- c(14,
                        15)

# Rename clusters
BNcommunities$`Cluster 1` <- BNcommunities$`1` 
BNcommunities$`1`  <- NULL

BNcommunities$`Cluster 2` <- BNcommunities$`2` 
BNcommunities$`2`  <- NULL

BNcommunities$`Covariates` <-BNcommunities$`3` 
BNcommunities$`3`  <- NULL
```

### Plot BN network with walktrap algorithm AND predictability of nodes 
Using mgm package
```{r plotting BN network with walktrap and predictability}
# Type of variable. C = categorical, g = gaussian
type = c(rep("c", 14),
         "g")

# Number of levels. For the first 14 variables, there are 2 levels (0 and 1). The last variable (age) is continuous so level is set to 1.
level = c(rep(2, 14), 
          1) 

BN_network <- mgm::mgm(mania_nodes_BN,
                  type = type,
                  level = level,
                  lambdaSel = "EBIC",
                  lambdaGam = 0.25,
                  binarySign = TRUE, 
                  scale = TRUE)

BN_network_plot <- qgraph::qgraph(BN_network$pairwise$wadj, # weighted adjacency matrix as input
       #layout = layout, 
       pie = error_list_BN, # provide errors as input
       pieColor = color_list,
       edge.color = "blue3",
       cut = 0, 
       labels = shortnames,
       nodeNames = longnames,
       groups =  BNcommunities,
       palette = "colorblind",
       label.scale = T,
       title = "Network of mania symptoms in BN sample,
                   n = 3,830"
      )
```

### Plot using the bootnet package for use in later analyses (e.g., centrality estimates, etc)
```{r plotting network using estimateNetwork BN}
BN_network_bootnet <- estimateNetwork(mania_nodes_BN,
                               default = "mgm",
                               type = type,
                               level = level,
                               tuning = 0.25,
                               binarySign = TRUE,
                               criterion = "EBIC",
                               labels = shortnames)

BN_network_bootnet_plot <- plot(BN_network_bootnet,
                           layout = "spring",
                           labels = shortnames, 
                           nodeNames = longnames,
                           legend = TRUE,
                           title = paste("Symptom network of mania items in BN sample,
                   n =", BN_network_bootnet$nPerson))
```

### BN network information
```{r BN network information BN}
BN_network_bootnet$graph # the weights (adjacency) matrix of the network (symmetrical in undirected networks)
BN_network_bootnet$intercepts # the thresholds (represent the intercept for each symptom in the regularized logistic regression analyses used to estimate the networks)
BN_network_bootnet$results # weights matrix and intercepts
BN_network_bootnet$labels # variable labels
BN_network_bootnet$nNodes # number of nodes in network
BN_network_bootnet$nPerson # number of persons in network
```

### BN centrality estimates
```{r centrality estimates BN}
# Raw centrality measures (not standardised)
qgraph::centrality(BN_network_bootnet)

# Standardised centrality estimates [node strength]
plot(qgraph::centrality(BN_network_bootnet)$InDegree,
     type = "b") 

# Standardised centrality estimated for four centrality indices
qgraph::centralityTable(BN_network_bootnet)

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/centrality_plot_BN_",date,".png")) 

qgraph::centralityPlot(BN_network_bootnet,
               include ="all",
               labels = longnames) 

dev.off()
```

### BN Edge weight accuracy
Use the bootnet() function to estimate edge weight accuracy and centrality stability and plot them
See: Estimating psychological networks and their accuracy: A tutorial paper
Bootstrapping = picking people with replacement, i.e. each sample will have a different composition of people (e.g. choosing a random 70% of the sample each time)
```{r edge weight accuracy BN network}
edge_accuracy_BN_network <- bootnet(BN_network_bootnet,
                                     nBoots = 1000, # 1000 bootstraps of networks using a different sub sample each time; compare all of these networks that we just estimated
                                     nCores = 4,
                                     statistics = c("edge", 
                                                    "strength",
                                                    "betweenness",
                                                    "closeness",
                                                    "expectedInfluence"),
                                     labels = shortnames
                                     ) 

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/edge_accuracy_plot_BN_",date,".png")) 

plot(edge_accuracy_BN_network,
                                      #plot = "interval",
                                      # split0 = TRUE,
                                      order = "sample",
                                       labels = FALSE)

dev.off()

edge_accuracy_BN_network_plot <- plot(edge_accuracy_BN_network,
                                      #plot = "interval",
                                      # split0 = TRUE,
                                      order = "sample",
                                       labels = TRUE)

edge_accuracy_BN_network_plot

# This function makes a ’multiverse’ plot of bootstrap results. Every row indicates an edge and every column a bootstrap; colors are in line of the edge strength as drawn with plot.bootnetResult.
#multiverse(edge_accuracy_BN_network_plot,
#           labels = T) 
```

### BN centrality accuracy
```{r centrality accuracy BN network}
centrality_stability_BN_network <- bootnet(BN_network_bootnet,
                                nBoots = 1000, 
                                nCores = 1,
                                type = "case", #case-dropping bootstrap
                                statistics = c("closeness",
                                               "strength",
                                               "betweenness",
                                               "expectedInfluence")) 

centrality_stability_BN_network

# Table of all statistics from original sample 
centrality_stability_BN_network$sampleTable 

# Results of bootstrap
centrality_stability_BN_network$boots

# Table of all statistics from bootstraps
centrality_stability_BN_network$bootTable

# Plot centrality stability
png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/centrality_stability_plot_BN_",date,".png")) 

plot(centrality_stability_BN_network,
                                              statistics = c("expectedInfluence"))

dev.off()

centrality_stability_BN_network_plot <- plot(centrality_stability_BN_network,
                                              statistics = c("closeness",
                                                             "strength",
                                                             "betweenness",
                                                             "expectedInfluence"))

centrality_stability_BN_network_plot


# CS-coefficient (to quantify the centrality stability)
corStability(centrality_stability_BN_network,
              cor = 0.7,
              statistics = "all")
```

### Test significance of differences (between edge weights and node centralities) to test for differences within a single network 
Significance: Specific edge weights 
```{r test significance of differences of specific edge weight BN network}
# Plot significant differences (alpha = 0.05) of edge weights:
png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/sig_diff_edges_plot_BN_",date,".png")) 

plot(edge_accuracy_BN_network,
     "edge",
     plot = "difference",
     onlyNonZero = TRUE,
     order = "sample",
     labels = TRUE
     )

dev.off()
```

Significance: Node centralities
```{r test significance of differences of node centralities BN network}
# Plot significant differences (alpha = 0.05) of node centrality eg. strength for all nodes:
png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/sig_diff_node_centralities_plot_BN_",date,".png")) 

plot(edge_accuracy_BN_network,
     "expectedInfluence",
     plot = "difference",
     order = "sample"
     ) # Note: use edge accuracy estimates for this as centrality is a measure of connecting edges

dev.off()
```

# BED
### Generate initial network for use in generating predictability estimates BED
```{r initial network for use in predictability BED}
# Type of variable. C = categorical, g = gaussian
type = c(rep("c", 14),
         "g")

# Number of levels. For the first 14 variables, there are 2 levels (0 and 1). The last variable (age) is continuous so level is set to 1.
level = c(rep(2, 14), 
          1) 

BED_network <- mgm::mgm(mania_nodes_BED,
                  type = type,
                  level = level,
                  lambdaSel = "EBIC",
                  lambdaGam = 0.25,
                  binarySign = TRUE, 
                  scale = TRUE)
```

### Adding predictability of nodes BED
From this paper: https://link.springer.com/article/10.3758/s13428-017-0910-x
```{r generating predictability of nodes BED}
p_obj <- predict(object = BED_network,
                 data = mania_nodes_BED,
                 errorCat = c("CC", "nCC", "CCmarg"),
                 errorCon = c("R2"))

p_obj$error

# To display both the accuracy of the intercept model and the normalized accuracy (contribution by other variables), we require a list for the ring-segments and a list for the corresponding colors:

error_list_BED <- list() # List for ring segments
beyondmarg <- vector()

for(i in 1:14) beyondmarg[[i]] <- p_obj$errors[i, 3]-p_obj$errors[i, 5]
for(i in 1:14) error_list_BED[[i]] <- c(p_obj$errors[i, 5], beyondmarg[[i]])
error_list_BED[[15]] <- p_obj$errors[15,2]

color_list <- list() # List for colours
for(i in 1:14) color_list[[i]] <- c("#ffa500", "#ff4300")
#color_list[[15]] <- p_obj$errors[15,2]
color_list[[15]] <- "#90B4D4"
```

### Walktrap algorithm: 
https://www.nature.com/articles/srep05918
https://pure.uva.nl/ws/files/21235882/Network_Analysis_on_Attitudes.png
Walktrap, developed by Pascal Pons, is an algorithm in graph theory, used to identify communities in large networks via random walks. These random walks are then used to compute distances between nodes. Nodes are then assigned into groups with small intra and larger inter-community distances via bottom-up hierarchical clustering. It should be noted, of course, that this algorithm considers only one community per node, which in some cases can be an incorrect hypothesis.
```{r walktrap algorithm BED}
# Create an igraph object containing the information on the  network and take the absolute values of the edge weights because the walktrap algorithm can only deal with positive edge values

BED_network <- estimateNetwork(mania_nodes_BED,
                               default = "mgm",
                               type = type,
                               level = level,
                               tuning = 0.25,
                               binarySign = TRUE)


BEDigraph <- igraph::graph_from_adjacency_matrix(abs(BED_network$graph), 
                                      weighted =TRUE,
                                      add.colnames = FALSE)


# Run walktrap algorithm on the network 
BEDCom <- igraph::cluster_walktrap(BEDigraph)

# Extract the found communities using the following command:
BEDcommunities <- igraph::communities(BEDCom)

# Manually move age and sex into their own community (they are covariates. We estimated the groups first because we need the associations that have been adjusted for age and sex, but do not want them to form part of a group because they are not symptoms)
BEDcommunities$`3` <- c(2,6,7,12,13)

BEDcommunities$`3` <- c(14,
                        15)

# Rename clusters
BEDcommunities$`Cluster 1` <- BEDcommunities$`1` 
BEDcommunities$`1`  <- NULL

BEDcommunities$`Cluster 2` <- BEDcommunities$`2` 
BEDcommunities$`2`  <- NULL

BEDcommunities$`Covariates` <-BEDcommunities$`3` 
BEDcommunities$`3`  <- NULL
```

### Plot BED network with walktrap algorithm AND predictability of nodes 
Using mgm package
```{r plotting BED network with walktrap and predictability}
# Type of variable. C = categorical, g = gaussian
type = c(rep("c", 14),
         "g")

# Number of levels. For the first 14 variables, there are 2 levels (0 and 1). The last variable (age) is continuous so level is set to 1.
level = c(rep(2, 14), 
          1) 

BED_network <- mgm::mgm(mania_nodes_BED,
                  type = type,
                  level = level,
                  lambdaSel = "EBIC",
                  lambdaGam = 0.25,
                  binarySign = TRUE, 
                  scale = TRUE)

BED_network_plot <- qgraph::qgraph(BED_network$pairwise$wadj, # weighted adjacency matrix as input
       #layout = layout, 
       pie = error_list_BED, # provide errors as input
       pieColor = color_list,
       edge.color = "blue3",
       cut = 0, 
       labels = shortnames,
       nodeNames = longnames,
       groups =  BEDcommunities,
       palette = "colorblind",
       label.scale = T,
       title = "Network of mania symptoms in BED sample,
                   n = 3667"
      )
```

### Plot using the bootnet package for use in later analyses (e.g., centrality estimates, etc)
```{r plotting network using estimateNetwork BED}
BED_network_bootnet <- estimateNetwork(mania_nodes_BED,
                               default = "mgm",
                               type = type,
                               level = level,
                               tuning = 0.25,
                               binarySign = TRUE,
                               criterion = "EBIC",
                               labels = shortnames)


BED_network_bootnet_plot <- plot(BED_network_bootnet,
                           layout = "spring",
                           labels = shortnames, 
                           nodeNames = longnames,
                           legend = TRUE,
                           title = paste("Symptom network of mania items in BED sample,
                   n =", BED_network_bootnet$nPerson))
```

### BED network information
```{r BED network information BED}
BED_network_bootnet$graph # the weights (adjacency) matrix of the network (symmetrical in undirected networks)
BED_network_bootnet$intercepts # the thresholds (represent the intercept for each symptom in the regularized logistic regression analyses used to estimate the networks)
BED_network_bootnet$results # weights matrix and intercepts
BED_network_bootnet$labels # variable labels
BED_network_bootnet$nNodes # number of nodes in network
BED_network_bootnet$nPerson # number of persons in network
```

### BED centrality estimates
```{r centrality estimates BED}
# Raw centrality measures (not standardised)
qgraph::centrality(BED_network_bootnet)

# Standardised centrality estimates [node strength]
plot(qgraph::centrality(BED_network_bootnet)$InDegree,
     type = "b") 

# Standardised centrality estimated for four centrality indices
qgraph::centralityTable(BED_network_bootnet)

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/centrality_plot_BED_",date,".png")) 

qgraph::centralityPlot(BED_network_bootnet,
               include ="all",
               labels = longnames) 

dev.off()
```

### BED Edge weight accuracy
Use the bootnet() function to estimate edge weight accuracy and centrality stability and plot them
See: Estimating psychological networks and their accuracy: A tutorial paper
Bootstrapping = picking people with replacement, i.e. each sample will have a different composition of people (e.g. choosing a random 70% of the sample each time)
```{r edge weight accuracy BED network}
edge_accuracy_BED_network <- bootnet(BED_network_bootnet,
                                     nBoots = 1000, 
                                     nCores = 4,
                                     statistics = c("edge", 
                                                    "strength",
                                                    "betweenness",
                                                    "closeness",
                                                    "expectedInfluence"),
                                     labels = shortnames
                                     ) 

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/edge_accuracy_plot_BED_",date,".png")) 

plot(edge_accuracy_BED_network,
                                      #plot = "interval",
                                      # split0 = TRUE,
                                      order = "sample",
                                       labels = FALSE)

dev.off()

edge_accuracy_BED_network_plot <- plot(edge_accuracy_BED_network,
                                      #plot = "interval",
                                      # split0 = TRUE,
                                      order = "sample",
                                       labels = TRUE)

edge_accuracy_BED_network_plot

# This function makes a ’multiverse’ plot of bootstrap results. Every row indicates an edge and every column a bootstrap; colors are in line of the edge strength as drawn with plot.bootnetResult.
#multiverse(edge_accuracy_BED_network_plot,
#           labels = T) 
```

### BED centrality accuracy
```{r centrality accuracy BED network}
centrality_stability_BED_network <- bootnet(BED_network_bootnet,
                                nBoots = 1000, 
                                nCores = 1,
                                type = "case", #case-dropping bootstrap
                                statistics = c("closeness",
                                               "strength",
                                               "betweenness",
                                               "expectedInfluence")) 

centrality_stability_BED_network

# Table of all statistics from original sample 
centrality_stability_BED_network$sampleTable 

# Results of bootstrap
centrality_stability_BED_network$boots

# Table of all statistics from bootstraps
centrality_stability_BED_network$bootTable

# Plot centrality stability
png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/centrality_stability_plot_BED_",date,".png")) 

plot(centrality_stability_BED_network,
                                              statistics = c("expectedInfluence"))

dev.off()

centrality_stability_BED_network_plot <- plot(centrality_stability_BED_network,
                                              statistics = c("closeness",
                                                             "strength",
                                                             "betweenness",
                                                             "expectedInfluence"))


centrality_stability_BED_network_plot


# CS-coefficient (to quantify the centrality stability)
corStability(centrality_stability_BED_network,
              cor = 0.7,
              statistics = "all")
```

### Test significance of differences (between edge weights and node centralities) to test for differences within a single network 
Significance: Specific edge weights 
```{r test significance of differences of specific edge weight BED network}
# Plot significant differences (alpha = 0.05) of edge weights:
png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/sig_diff_edges_plot_BED_",date,".png")) 

plot(edge_accuracy_BED_network,
     "edge",
     plot = "difference",
     onlyNonZero = TRUE,
     order = "sample",
     labels = TRUE
     )

dev.off()
```


Significance: Node centralities
```{r test significance of differences of node centralities BED network}
# Plot significant differences (alpha = 0.05) of node centrality eg. strength for all nodes:
png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/sig_diff_node_centralities_plot_BED_",date,".png")) 

plot(edge_accuracy_BED_network,
     "expectedInfluence",
     plot = "difference",
     order = "sample"
     ) # Note: use edge accuracy estimates for this as centrality is a measure of connecting edges

dev.off()
# Test for difference in strength between specific nodes - perhaps more useful if you have apriori reason to explore specific differents in nodes
# Eg. difference in centrality between ene and expectedInfluence for strength 
# differenceTest(edge_accuracy_ED_network,  "ene", "rac", "expectedInfluence")
```

### Average layout
Calculate average layout of all 4 networks to then constrain them all to that layout (don't use Fruchterman-Reingold)
```{r calculating average layout}
average_layout <- qgraph::averageLayout(BED_network_plot,
                                ANB_network_plot,
                                BN_network_plot)
```

Re-plot each using 'average_layout'
```{r re-plot each using average layout}
# ANB
ANB_network_plot <- qgraph::qgraph(ANB_network$pairwise$wadj, # weighted adjacency matrix as input
       layout = average_layout, 
       pie = error_list_ANB, # provide errors as input
       pieColor = color_list,
       edge.color = "blue3",
       cut = 0, 
       labels = shortnames,
       nodeNames = longnames,
       groups =  ANBcommunities,
       color = c("orange",
                 "light blue",
                 "grey" # covariates in grey
                 ),
       palette = "colorblind",
       label.scale = T,
       title = "Network of mania symptoms in ANB sample,
                   n = 400",
       filetype = "png",
       filename = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/network_ANB_average_layout"),
       width = 10,
       height = 10
      )

# BN
BN_network_plot <- qgraph::qgraph(BN_network$pairwise$wadj, # weighted adjacency matrix as input
       layout = average_layout, 
       pie = error_list_BN, # provide errors as input
       pieColor = color_list,
       edge.color = "blue3",
       cut = 0, 
       labels = shortnames,
       nodeNames = longnames,
       groups =  BNcommunities,
       palette = "colorblind",
       color = c("orange",
                 "light blue",
                  "grey" # covariates in grey
                 ),
       label.scale = T,
       title = "Network of mania symptoms in BN sample,
                   n = 3830",
       filetype = "png",
       filename = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/network_BN_average_layout"),
       width = 10,
       height = 10
      )

# BED
BED_network_plot <- qgraph::qgraph(BED_network$pairwise$wadj, # weighted adjacency matrix as input
       layout = average_layout, 
       pie = error_list_BED, # provide errors as input
       pieColor = color_list,
       edge.color = "blue3",
       cut = 0, 
       labels = shortnames,
       nodeNames = longnames,
       groups =  BEDcommunities,
       palette = "colorblind",
       color = c("orange",
                 "light blue",
                 "grey" # covariates in grey
                 ),
       label.scale = T,
       title = "Network of mania symptoms in BED sample,
                   n = 3667",
       filetype = "png",
       filename = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/network_BED_average_layout"),
       width = 10,
       height = 10
      )
```


# DIAGNOSIS LEVEL- COMPARING NETWORKS
## ANB vs BN
### 1. Correlation of the weighted adjacency matrix of both models
```{r ANB vs BN correlation of weighted adjacency matrices}
# Drop age and sex from adjacency matrices
ANB_network_no_age_sex <- tril(ANB_network_bootnet$graph) 
ANB_network_no_age_sex <- ANB_network_no_age_sex[-c(14,15),-c(14,15)]
diag(ANB_network_no_age_sex) <- NA_real_
ANB_network_no_age_sex <- as.vector(ANB_network_no_age_sex)

BN_network_no_age_sex <- tril(BN_network_bootnet$graph) 
BN_network_no_age_sex <- BN_network_no_age_sex[-c(14,15),-c(14,15)]
diag(BN_network_no_age_sex) <- NA_real_
BN_network_no_age_sex <- as.vector(BN_network_no_age_sex)

corr_no_age_sex <- cor.test(x=ANB_network_no_age_sex,
                 y=BN_network_no_age_sex,
                 method = 'spearman')

corr_no_age_sex # 0.7
corr_no_age_sex$p.value # 1.300678e-24
```

### 2. Absolute sum of adjacency matrices for the two networks [edge weights]
```{r ANB versus BN absolute sum of adjacency matrices}
sum(abs(na.omit(BN_network_no_age_sex))) 
sum(abs(na.omit(ANB_network_no_age_sex)))
```

### 3. Compare centrality
```{r ANB vs BN compare centrality}
# Plot centrality differences
ANB_vs_BN_centrality_plot <- centralityPlot(list( "Anorexia binge-eating" = ANB_network_bootnet,
               "Bulimia" = BN_network_bootnet),
               include = "ExpectedInfluence",
               orderBy = "ExpectedInfluence",
               labels = longnames)

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/centrality_diff_ANB_vs_BN_",date,".png"))

ANB_vs_BN_centrality_plot + labs(x = "Centrality indices",
            y = "Nodes",
            colour = "Comparison group")

dev.off()
```

### 4. Compare networks using the Network Comparison Test
~runs 5000 networks with the same sample sizes as your original two, but randomly assigning people to each one.  Creates a distribution of the null hypothesis - this shows what our networks would look like assuming that ED does not matter. We then compare our actual network to this network. Then sees if the differences you found are bigger than random differences you get when you just split the sample into those size groups

~the 5000 permutations are run, and the value of difference between the networks in each of the permutations is put into a distribution. That's the distribution that is then used to assess whether your original difference was big enough to be significant, if a larger difference is found only in less that 5% of permutations you conclude that the difference you found was just to your group allocation, not just to chance

~if significant: significant over and above differences you get just comparing samples of X to samples of Y

~ NCT uses information from edge weights; need to look at edge weight accuracy to ensure I can interpret NCT 

```{r ANB vs BN compare centrality Network Comparison Test}
# Use output from estimatenetwork as data, that way specific settings eg. model and tuning are retained
networkcomparison_ANB_BN <- NCT(ANB_network_bootnet,
                         BN_network_bootnet,
                         it = 1000,
                         test.edges = T,
                         edges=list(c(1,2), # List all edges other than age and sex
                                    c(1,3),
                                    c(1,4),
                                    c(1,5),
                                    c(1,6),
                                    c(1,7),
                                    c(1,8),
                                    c(1,9),
                                    c(1,10),
                                    c(1,11),
                                    c(1,12),
                                    c(1,13),
           
                                    c(2,3),
                                    c(2,4),
                                    c(2,5),
                                    c(2,6),
                                    c(2,7),
                                    c(2,8),
                                    c(2,9),
                                    c(2,10),
                                    c(2,11),
                                    c(2,12),
                                    c(2,13),
           
                                    c(3,4),
                                    c(3,5),
                                    c(3,6),
                                    c(3,7),
                                    c(3,8),
                                    c(3,9),
                                    c(3,10),
                                    c(3,11),
                                    c(3,12),
                                    c(3,13),
           
                                    c(4,5),
                                    c(4,6),
                                    c(4,7),
                                    c(4,8),
                                    c(4,9),
                                    c(4,10),
                                    c(4,11),
                                    c(4,12),
                                    c(4,13),
                                    
                                    c(5,6),
                                    c(5,7),
                                    c(5,8),
                                    c(5,9),
                                    c(5,10),
                                    c(5,11),
                                    c(5,12),
                                    c(5,13),
          
          
                                    c(6,7),
                                    c(6,8),
                                    c(6,9),
                                    c(6,10),
                                    c(6,11),
                                    c(6,12),
                                    c(6,13),
           
                                    c(7,8),
                                    c(7,9),
                                    c(7,10),
                                    c(7,11),
                                    c(7,12),
                                    c(7,13),
           
                                    c(8,9),
                                    c(8,10),
                                    c(8,11),
                                    c(8,12),
                                    c(8,13),
          
                                    c(9,10),
                                    c(9,11),
                                    c(9,12),
                                    c(9,13),
           
                                    c(10,11),
                                    c(10,12),
                                    c(10,13),
           
                                    c(11,12),
                                    c(11,13),
                                    
                                    c(12,13)
                         ), 
           
                         test.centrality = TRUE,
                         centrality = c("closeness",
                                        "betweenness",
                                        "strength",
                                        "expectedInfluence"),
                         nodes = 1:13, # List all nodes other than age and sex
                         p.adjust.methods = "bonferroni"
                         )

networkcomparison_ANB_BN
```

### 5. Global strength: ANB versus BN differences 
```{r ANB versus BN Network Comparison Test results - global strength}
networkcomparison_ANB_BN$glstrinv.sep # global strength of each network - adding up all the networks in each network, is there a difference?
networkcomparison_ANB_BN$glstrinv.real # difference in global strength
networkcomparison_ANB_BN$glstrinv.pval # significance of difference in global strength

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/global_strength_plot_ANB_vs_BN_",date,".png")) 

plot(networkcomparison_ANB_BN, what = "strength") # the results of the global strength test can be plotted

dev.off()
```

### 6. Network structure: ANB versus BN differences 
Results can also be plotted. The permutation test results in a reference distribution of test statistics under the relevant null hypothesis. NCT is accompanied by a plotting function to visualizethe results. The red triangle indicates the test statistics based on the observed (real) data.
IF 0, just say p < 0.001
```{r ANB versus BN Network Comparison Test results - network structure}
networkcomparison_ANB_BN$nwinv.real # max difference in network structure
networkcomparison_ANB_BN$nwinv.pval # significance of difference in structure/organisation

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/network_structure_plot_ANB_vs_BN_",date,".png")) 

plot(networkcomparison_ANB_BN, # the results of the network structure test can be plotted
     what = "network")

dev.off()
```

### 6a. If significant - SPECIFIC EDGE WEIGHT DIFFERENCES 
NB: When writing up, will need to refer back to the networks to see which edge weight was stronger and in which model. This only tells you if the difference was significant, not in which direction.
```{r ANB versus BN Network Comparison Test results - specific edge weights}
networkcomparison_ANB_BN$einv.real # difference in edge weights of observed networks
networkcomparison_ANB_BN$einv.pvals # The Holm-Bonferroni corrected p values per edge from the permutation test concerning differences in edges weight
networkcomparison_ANB_BN$einv.perm # The values of the difference in edge weight of the permuted networks. Only iftest.edges =TRUE 
# plot(networkcomparison_ANB_BN, # The distribution(s) of the edge strength invariance test can be plotted
 #    what="edge")

# more_talkative_numeric	racing_thoughts_numeric
edge_accuracy_BN_network$sampleTable  # 0.741703146	
edge_accuracy_ANB_network$sampleTable # 0.00
```

### 7. Significant centrality differences
```{r ANB versus BN Network Comparison Test results - significant differences centrality}
networkcomparison_ANB_BN$diffcen.real # The values of the difference in centralities of the OBSERVED networks. 
networkcomparison_ANB_BN$diffcen.perm # The values of the difference in centralities of the PERMUTED networks. 
networkcomparison_ANB_BN$diffcen.pval # p-values (corrected for multiple testing or not according to ’p.adjust.methods’) per node from the permutation test concerning differences in centralities. 
```

## ANB vs BED
### 1. Correlation of the weighted adjacency matrix of both models
```{r ANB vs BED correlation of weighted adjacency matrices}
# Drop age and sex from adjacency matrices
BED_network_no_age_sex <- tril(BED_network_bootnet$graph) 
BED_network_no_age_sex <- BED_network_no_age_sex[-c(14,15),-c(14,15)]
diag(BED_network_no_age_sex) <- NA_real_
BED_network_no_age_sex <- as.vector(BED_network_no_age_sex)

corr_no_age_sex <- cor.test(x=ANB_network_no_age_sex,
                 y=BED_network_no_age_sex,
                 method = 'spearman')

corr_no_age_sex # 0.67
corr_no_age_sex$p.value # 2.06603e-21
```

### 2. Absolute sum of adjacency matrices for the two networks [edge weights]
```{r ANB vs BED absolute sum of adjacency matrices}
sum(abs(na.omit(BED_network_no_age_sex))) 
sum(abs(na.omit(ANB_network_no_age_sex)))
```

### 3. Compare centrality
```{r ANB vs BED compare centrality}
# Plot centrality differences
ANB_vs_BED_centrality_plot <- centralityPlot(list( "Anorexia binge-eating" = ANB_network_bootnet,
               "Binge-eating disorder" = BED_network_bootnet),
               include = "ExpectedInfluence",
               orderBy = "ExpectedInfluence",
               labels = longnames)

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/centrality_diff_ANB_vs_BED_",date,".png"))

ANB_vs_BED_centrality_plot + labs(x = "Centrality indices",
            y = "Nodes",
            colour = "Comparison group")

dev.off()
```

### 4. Compare networks using the Network Comparison Test
```{r ANB vs BED compare centrality Network Comparison Test}
# Use output from estimatenetwork as data, that way specific settings eg. model and tuning are retained
networkcomparison_ANB_BED <- NCT(ANB_network_bootnet,
                         BED_network_bootnet,
                         it = 1000, 
                         test.edges = T,
                         edges=list(c(1,2), # List all edges other than age and sex
                                    c(1,3),
                                    c(1,4),
                                    c(1,5),
                                    c(1,6),
                                    c(1,7),
                                    c(1,8),
                                    c(1,9),
                                    c(1,10),
                                    c(1,11),
                                    c(1,12),
                                    c(1,13),
           
                                    c(2,3),
                                    c(2,4),
                                    c(2,5),
                                    c(2,6),
                                    c(2,7),
                                    c(2,8),
                                    c(2,9),
                                    c(2,10),
                                    c(2,11),
                                    c(2,12),
                                    c(2,13),
           
                                    c(3,4),
                                    c(3,5),
                                    c(3,6),
                                    c(3,7),
                                    c(3,8),
                                    c(3,9),
                                    c(3,10),
                                    c(3,11),
                                    c(3,12),
                                    c(3,13),
           
                                    c(4,5),
                                    c(4,6),
                                    c(4,7),
                                    c(4,8),
                                    c(4,9),
                                    c(4,10),
                                    c(4,11),
                                    c(4,12),
                                    c(4,13),
                                    
                                    c(5,6),
                                    c(5,7),
                                    c(5,8),
                                    c(5,9),
                                    c(5,10),
                                    c(5,11),
                                    c(5,12),
                                    c(5,13),
          
          
                                    c(6,7),
                                    c(6,8),
                                    c(6,9),
                                    c(6,10),
                                    c(6,11),
                                    c(6,12),
                                    c(6,13),
           
                                    c(7,8),
                                    c(7,9),
                                    c(7,10),
                                    c(7,11),
                                    c(7,12),
                                    c(7,13),
           
                                    c(8,9),
                                    c(8,10),
                                    c(8,11),
                                    c(8,12),
                                    c(8,13),
          
                                    c(9,10),
                                    c(9,11),
                                    c(9,12),
                                    c(9,13),
           
                                    c(10,11),
                                    c(10,12),
                                    c(10,13),
           
                                    c(11,12),
                                    c(11,13),
                                    
                                    c(12,13)
                         ), 
           
                         test.centrality = TRUE,
                         centrality = c("closeness",
                                        "betweenness",
                                        "strength",
                                        "expectedInfluence"),
                         nodes = 1:13, # List all nodes other than age and sex
                         p.adjust.methods = "bonferroni"
                         )

networkcomparison_ANB_BED
```

### 5. Global strength: ANB versus BED differences 
```{r ANB versus BED Network Comparison Test results - global strength}
networkcomparison_ANB_BED$glstrinv.sep # global strength of each network - adding up all the networks in each network, is there a difference?
networkcomparison_ANB_BED$glstrinv.real # difference in global strength
networkcomparison_ANB_BED$glstrinv.pval # significance of difference in global strength

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/global_strength_plot_ANB_vs_BED_",date,".png")) 

plot(networkcomparison_ANB_BED, what = "strength") # the results of the global strength test can be plotted

dev.off()
```

### 6. Network structure: ANB versus BED differences 
Results can also be plotted. The permutation test results in a reference distribution of test statistics under the relevant null hypothesis. NCT is accompanied by a plotting function to visualize the results. The red triangle indicates the test statistics based on the observed (real) data.
IF 0, just say p < 0.001
```{r ANB versus BED Network Comparison Test results - network structure}
networkcomparison_ANB_BED$nwinv.real # max difference in network structure
networkcomparison_ANB_BED$nwinv.pval

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/network_structure_plot_ANB_vs_BED_",date,".png")) 

plot(networkcomparison_ANB_BED, # the results of the network structure test can be plotted
     what = "network")

dev.off()
```

### 6a. If significant - SPECIFIC EDGE WEIGHT DIFFERENCES 
NB: When writing up, will need to refer back to the networks to see which edge weight was stronger and in which model. This only tells you if the difference was significant, not in which direction.
```{r ANB versus BED Network Comparison Test results - specific edge weights}
networkcomparison_ANB_BED$einv.real # difference in edge weights of observed networks
networkcomparison_ANB_BED$einv.pvals # The Bonferroni corrected p values per edge from the permutation test concerning differences in edges weight
networkcomparison_ANB_BED$einv.perm # The values of the difference in edge weight of the permuted networks. Only iftest.edges =TRUE 
# plot(networkcomparison_ANB_BN, # The distribution(s) of the edge strength invariance test can be plotted
 #    what="edge")

edge_accuracy_BED_network$sampleTable
edge_accuracy_ANB_network$sampleTable 
```

### 7. Significant centrality differences
```{r ANB versus BED Network Comparison Test results - significant differences centrality}
networkcomparison_ANB_BED$diffcen.real # The values of the difference in centralities of the OBSERVED networks. 
networkcomparison_ANB_BED$diffcen.perm # The values of the difference in centralities of the PERMUTED networks. 
networkcomparison_ANB_BED$diffcen.pval # p-values (corrected for multiple testing or not according to ’p.adjust.methods’) per node from the permutation test concerning differences in centralities. 
```

## BN vs BED
### 1. Correlation of the weighted adjacency matrix of both models
```{r BN vs BED correlation of weighted adjacency matrices}
# Drop age and sex from adjacency matrices
corr_no_age_sex <- cor.test(x=BN_network_no_age_sex,
                 y=BED_network_no_age_sex,
                 method = 'spearman')

corr_no_age_sex # 0.87
corr_no_age_sex$p.value # 3.973111e-48
```

### 2. Absolute sum of adjacency matrices for the two networks [edge weights]
```{r BN vs BED absolute sum of adjacency matrices}
sum(abs(na.omit(BED_network_no_age_sex))) 
sum(abs(na.omit(BN_network_no_age_sex)))
```

### 3. Compare centrality
```{r BN vs BED compare centrality}
# Plot centrality differences
BN_vs_BED_centrality_plot <- centralityPlot(list( "Bulimia" = BN_network_bootnet,
               "Binge-eating disorder" = BED_network_bootnet),
               include = "ExpectedInfluence",
               orderBy = "ExpectedInfluence",
               labels = longnames)

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/centrality_diff_BN_vs_BED_",date,".png"))

BN_vs_BED_centrality_plot + labs(x = "Centrality indices",
            y = "Nodes",
            colour = "Comparison group")

dev.off()
```

### 4. Compare networks using the Network Comparison Test
```{r BN vs BED compare centrality Network Comparison Test}
# Use output from estimatenetwork as data, that way specific settings eg. model and tuning are retained
networkcomparison_BN_BED <- NCT(BN_network_bootnet,
                         BED_network_bootnet,
                         it = 1000, 
                         test.edges = T,
                         edges=list(c(1,2), # List all edges other than age and sex
                                    c(1,3),
                                    c(1,4),
                                    c(1,5),
                                    c(1,6),
                                    c(1,7),
                                    c(1,8),
                                    c(1,9),
                                    c(1,10),
                                    c(1,11),
                                    c(1,12),
                                    c(1,13),
           
                                    c(2,3),
                                    c(2,4),
                                    c(2,5),
                                    c(2,6),
                                    c(2,7),
                                    c(2,8),
                                    c(2,9),
                                    c(2,10),
                                    c(2,11),
                                    c(2,12),
                                    c(2,13),
           
                                    c(3,4),
                                    c(3,5),
                                    c(3,6),
                                    c(3,7),
                                    c(3,8),
                                    c(3,9),
                                    c(3,10),
                                    c(3,11),
                                    c(3,12),
                                    c(3,13),
           
                                    c(4,5),
                                    c(4,6),
                                    c(4,7),
                                    c(4,8),
                                    c(4,9),
                                    c(4,10),
                                    c(4,11),
                                    c(4,12),
                                    c(4,13),
                                    
                                    c(5,6),
                                    c(5,7),
                                    c(5,8),
                                    c(5,9),
                                    c(5,10),
                                    c(5,11),
                                    c(5,12),
                                    c(5,13),
          
          
                                    c(6,7),
                                    c(6,8),
                                    c(6,9),
                                    c(6,10),
                                    c(6,11),
                                    c(6,12),
                                    c(6,13),
           
                                    c(7,8),
                                    c(7,9),
                                    c(7,10),
                                    c(7,11),
                                    c(7,12),
                                    c(7,13),
           
                                    c(8,9),
                                    c(8,10),
                                    c(8,11),
                                    c(8,12),
                                    c(8,13),
          
                                    c(9,10),
                                    c(9,11),
                                    c(9,12),
                                    c(9,13),
           
                                    c(10,11),
                                    c(10,12),
                                    c(10,13),
           
                                    c(11,12),
                                    c(11,13),
                                    
                                    c(12,13)
                         ), 
           
                         test.centrality = TRUE,
                         centrality = c("closeness",
                                        "betweenness",
                                        "strength",
                                        "expectedInfluence"),
                         nodes = 1:13, # List all nodes other than age and sex
                         p.adjust.methods = "bonferroni"
                         )

networkcomparison_BN_BED
```

### 5. Global strength: BN versus BED differences 
```{r BN versus BED Network Comparison Test results - global strength}
networkcomparison_BN_BED$glstrinv.sep # global strength of each network - adding up all the networks in each network, is there a difference?
networkcomparison_BN_BED$glstrinv.real # difference in global strength
networkcomparison_BN_BED$glstrinv.pval # significance of difference in global strength

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/global_strength_plot_BN_vs_BED_",date,".png")) 

plot(networkcomparison_BN_BED, what = "strength") # the results of the global strength test can be plotted

dev.off()
```

### 6. Network structure: BN vs VED differences 
Results can also be plotted. The permutation test results in a reference distribution of test statistics under the relevant null hypothesis. NCT is accompanied by a plotting function to visualizethe results. The red triangle indicates the test statistics based on the observed (real) data.
IF 0, just say p < 0.001
```{r BN versus BED Network Comparison Test results - network structure}
networkcomparison_BN_BED$nwinv.real # max difference in network structure
networkcomparison_BN_BED$nwinv.pval # significance of difference in structure/organisation

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/network_structure_plot_BN_vs_BED_",date,".png")) 

plot(networkcomparison_BN_BED, # the results of the network structure test can be plotted
     what = "network")

dev.off()
```

### 6a. If significant - SPECIFIC EDGE WEIGHT DIFFERENCES 
NB: When writing up, will need to refer back to the networks to see which edge weight was stronger and in which model. This only tells you if the difference was significant, not in which direction.
```{r BN versus BED Network Comparison Test results - specific edge weights}
networkcomparison_BN_BED$einv.real # difference in edge weights of observed networks
networkcomparison_BN_BED$einv.pvals # The Holm-Bonferroni corrected p values per edge from the permutation test concerning differences in edges weight
networkcomparison_BN_BED$einv.perm # The values of the difference in edge weight of the permuted networks. Only iftest.edges =TRUE 
# plot(networkcomparison_ANB_BN, # The distribution(s) of the edge strength invariance test can be plotted
 #    what="edge")
```

### 7. Significant centrality differences
```{r BN versus BED  Network Comparison Test results - significant differences centrality}
networkcomparison_BN_BED$diffcen.real # The values of the difference in centralities of the OBSERVED networks. 
networkcomparison_BN_BED$diffcen.perm # The values of the difference in centralities of the PERMUTED networks. 
networkcomparison_BN_BED$diffcen.pval # p-values (corrected for multiple testing or not according to ’p.adjust.methods’) per node from the permutation test concerning differences in centralities. 
```

# Compare centrality indices: MULTIPLE COMPARISONS
```{r Compare centrality indicies both}
centralityplot <- centralityPlot(list("Anorexia nervosa binge-eating" = ANB_network_bootnet,
                                      "Bulimia nervosa" = BN_network_bootnet,
                                      "Binge-eating disorder" = BED_network_bootnet),
                                      include = "ExpectedInfluence",
                                      orderBy = "ExpectedInfluence",
                                      labels = longnames)

png(file = paste0(filepath_plots, "/revised_diagnosis/sensitivity_analysis/3.ANB_only/centrality_diff_sens_ANB_BN_BED_",date,".png"))

centralityplot + 
   labs(x = "Centrality indices",
            y = "Nodes",
            colour = "Comparison group")

dev.off()
```
